{% extends "base.html" %}

{% block content %}
<div class="forms-container">
    <h2>Submit Form</h2>

    {% if not form_enabled %}
    <div class="form-disabled-message">
        <p>The form is currently disabled by HR.</p>
    </div>
    {% else %}
    <form id="submission-form" class="form">
        {% for category in critical_incidents.keys() %}
        <div class="form-group" id="{{ category }}-group">
            <div class="category-header">
                <span class="category-title">{{ category }}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="{{ category }}-checkbox" name="{{ category }}-checkbox" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            {% if critical_incidents[category] %}
            <div class="existing-critical-incidents">
                <h4>Your existing critical incidents:</h4>
                {% for critical_incident in critical_incidents[category] %}
                <div class="critical-incident-reference">
                    <p>{{ critical_incident.message }}</p>
                    <button
                        type="button"
                        class="use-critical-incident-btn"
                        data-category="{{ category }}"
                        data-message="{{ critical_incident.message }}"
                    >
                        Use this critical incident
                    </button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="dynamic-inputs" id="{{ category }}-inputs">
                <div class="input-group">
                    <textarea
                        class="form-input"
                        name="{{ category }}[]"
                        placeholder="Enter your {{ category | lower }} critical incident"
                    ></textarea>
                    <button type="button" class="remove-input-btn" style="display: none;">Remove</button>
                </div>
            </div>

            <button
                type="button"
                class="add-input-btn"
                data-category="{{ category }}"
            >
                Add another {{ category | lower }} critical incident
            </button>

            <div class="additional-fields" id="{{ category }}-additional-fields">
                <div class="form-group">
                    <label for="{{ category }}-measure">Measure of Success</label>
                    <input type="text" id="{{ category }}-measure" name="{{ category }}-measure" data-required="true">
                </div>

                <div class="form-group">
                    <label for="{{ category }}-completion">Percentage of Completion</label>
                    <select id="{{ category }}-completion" name="{{ category }}-completion" data-required="true">
                        <option value=">=110%">>=110%</option>
                        <option value="90-109%">90-109%</option>
                        <option value="70-89%">70-89%</option>
                        <option value="50-69%">50-69%</option>
                        <option value="below 50%">below 50%</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="{{ category }}-comments">Comments on Achievement</label>
                    <textarea id="{{ category }}-comments" name="{{ category }}-comments" data-required="true"></textarea>
                </div>

                <div class="form-group">
                    <label for="{{ category }}-self-rating">Self-Assessment Rating</label>
                    <select id="{{ category }}-self-rating" name="{{ category }}-self-rating" data-required="true">
                        <option value="Excellent">Excellent</option>
                        <option value="Very Good">Very Good</option>
                        <option value="Good">Good</option>
                        <option value="Needs Improvement">Needs Improvement</option>
                        <option value="Below Expectations">Below Expectations</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="{{ category }}-manager-rating">
                        {% if session.get('role') == 'manager' %}
                        HR Rating
                        {% else %}
                        Reporting Manager Rating
                        {% endif %}
                    </label>
                    <select id="{{ category }}-manager-rating" name="{{ category }}-manager-rating" disabled required>
                        {% if submission and submission.data[category + '-manager-rating'] %}
                            <option value="Excellent" {% if submission.data[category + '-manager-rating'] == 'Excellent' %}selected{% endif %}>Excellent</option>
                            <option value="Very Good" {% if submission.data[category + '-manager-rating'] == 'Very Good' %}selected{% endif %}>Very Good</option>
                            <option value="Good" {% if submission.data[category + '-manager-rating'] == 'Good' %}selected{% endif %}>Good</option>
                            <option value="Needs Improvement" {% if submission.data[category + '-manager-rating'] == 'Needs Improvement' %}selected{% endif %}>Needs Improvement</option>
                            <option value="Below Expectations" {% if submission.data[category + '-manager-rating'] == 'Below Expectations' %}selected{% endif %}>Below Expectations</option>
                        {% else %}
                            <option value="" selected>Unavailable</option>
                        {% endif %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="{{ category }}-manager-comments">
                        {% if session.get('role') == 'manager' %}
                        HR Comments
                        {% else %}
                        Comments by Reporting Manager
                        {% endif %}
                    </label>
                    <textarea id="{{ category }}-manager-comments" name="{{ category }}-manager-comments" disabled required>{{ submission.data[category + '-manager-comments'] if submission and submission.data[category + '-manager-comments'] else 'Unavailable' }}</textarea>
                </div>
            </div>
        </div>
        {% endfor %}

        <button type="submit" class="submit-btn">Submit Form</button>
    </form>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function addInputField(category, value = '') {
        const container = document.getElementById(`${category}-inputs`);
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';

        inputGroup.innerHTML = `
            <textarea
                class="form-input"
                name="${category}[]"
                placeholder="Enter your ${category.toLowerCase()} critical incident"
            >${value}</textarea>
            <button type="button" class="remove-input-btn">Remove</button>
        `;

        container.appendChild(inputGroup);
        updateRemoveButtons(category);
    }

    function updateRemoveButtons(category) {
        const container = document.getElementById(`${category}-inputs`);
        const removeButtons = container.querySelectorAll('.remove-input-btn');
        removeButtons.forEach(btn => {
            btn.style.display = removeButtons.length > 1 ? 'block' : 'none';
        });
    }

    document.querySelectorAll('.add-input-btn').forEach(button => {
        button.addEventListener('click', () => {
            const category = button.dataset.category;
            addInputField(category);
        });
    });

    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-input-btn')) {
            const inputGroup = e.target.closest('.input-group');
            const category = e.target.closest('.dynamic-inputs').id.replace('-inputs', '');
            inputGroup.remove();
            updateRemoveButtons(category);
        }
    });

    document.querySelectorAll('.use-critical-incident-btn').forEach(button => {
        button.addEventListener('click', () => {
            const category = button.dataset.category;
            const message = button.dataset.message;
            addInputField(category, message);
        });
    });

    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            const category = e.target.id.replace('-checkbox', '');
            const categoryGroup = document.getElementById(`${category}-group`);
            const additionalFields = document.getElementById(`${category}-additional-fields`);
            const fields = additionalFields.querySelectorAll('[data-required="true"]');
            
            if (e.target.checked) {
                categoryGroup.classList.remove('deselected');
                additionalFields.style.display = 'block';
                fields.forEach(field => field.setAttribute('required', ''));
            } else {
                categoryGroup.classList.add('deselected');
                additionalFields.style.display = 'none';
                fields.forEach(field => field.removeAttribute('required'));
            }
        });
        
        // Initialize the state on page load
        checkbox.dispatchEvent(new Event('change'));
    });

    const form = document.getElementById('submission-form');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {};
            const uniqueCriticalIncidents = new Map();
            let hasSelectedCategory = false;

            // Get all category groups
            const categories = form.querySelectorAll('.form-group[id$="-group"]');
            categories.forEach(categoryGroup => {
                const categoryId = categoryGroup.id.replace('-group', '');
                const categoryCheckbox = document.getElementById(`${categoryId}-checkbox`);
                
                // Only process if category is checked
                if (categoryCheckbox && categoryCheckbox.checked) {
                    // Get critical incident inputs for this category
                    const inputs = categoryGroup.querySelectorAll(`textarea[name="${categoryId}[]"]`);
                    const values = Array.from(inputs)
                        .map(input => input.value.trim())
                        .filter(value => value !== '');

                    // Store critical incidents if any exist
                    if (values.length > 0) {
                        hasSelectedCategory = true;
                        formData[categoryId] = values;

                        // Track unique critical incidents
                        values.forEach(message => {
                            const key = `${categoryId}-${message}`;
                            if (!uniqueCriticalIncidents.has(key)) {
                                uniqueCriticalIncidents.set(key, { category: categoryId, message });
                            }
                        });

                        // Get additional fields
                        formData[`${categoryId}-measure`] = document.getElementById(`${categoryId}-measure`).value;
                        formData[`${categoryId}-completion`] = document.getElementById(`${categoryId}-completion`).value;
                        formData[`${categoryId}-comments`] = document.getElementById(`${categoryId}-comments`).value;
                        formData[`${categoryId}-self-rating`] = document.getElementById(`${categoryId}-self-rating`).value;
                        formData[`${categoryId}-manager-rating`] = '';
                        formData[`${categoryId}-manager-comments`] = '';
                    }
                }
            });

            if (!hasSelectedCategory) {
                alert('Please fill out at least one category with critical incidents');
                return;
            }

            try {
                const response = await fetch('/api/submit-form', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        formData,
                        newCriticalIncidents: Array.from(uniqueCriticalIncidents.values())
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to submit form');
                }

                alert('Form submitted successfully');
                window.location.reload();
            } catch (error) {
                alert(error.message);
            }
        });
    }
});
</script>
{% endblock %}
