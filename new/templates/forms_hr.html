{% extends "base.html" %}

{% block content %}
<style>
.input-container {
    position: relative;
    width: 100%;
}

.input-container textarea {
    width: 100%;
    padding-right: 30px;
}

.mic-icon {
    position: absolute;
    right: 8px;
    top: 8px;
    width: 16px;
    height: 16px;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z'/%3E%3C/svg%3E") no-repeat center;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
    border: none;
    background-color: transparent;
}

.mic-icon:hover {
    opacity: 1;
}

.mic-active {
    opacity: 1;
    color: #ff4444;
}

.critical-incidents-container {
    padding: 0.75rem;
    background-color: #f8fafc;
    border-radius: 0.375rem;
    border: 1px solid #e2e8f0;
    margin-bottom: 1rem;
}
ul{
    margin-left: 30px;
}
</style>
<div class="forms-container">
    <div class="forms-header">
        <h2>Form Submissions</h2>
        <button id="toggle-form" class="toggle-button">
            {{ 'Disable Form' if form_enabled else 'Enable Form' }}
        </button>
    </div>

    <div class="submissions-list">
        {% for submission in submissions %}
        <div class="submission-card" data-submission-id="{{ submission._id }}">
            <div class="submission-header">
                Submitted by: {{ submission.employee_name }}
                <span class="submission-date">
                    {{ submission.created_at.strftime('%B %d, %Y, %I:%M:%S %p') }}
                </span>
            </div>
            {% for category, messages in submission.data.items() %}
            {% if not category.endswith('-measure') and not category.endswith('-completion') and not category.endswith('-comments') and not category.endswith('-self-rating') and not category.endswith('-manager-rating') and not category.endswith('-manager-comments') %}
            <div class="submission-item">
                <strong>{{ category }}:</strong>
                <div class="critical-incidents-container">
                    <ul>
                        {% for message in messages %}
                        <li>{{ message }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="form-group">
                <label for="{{ category }}-measure">Measure of Success</label>
                <input type="text" id="{{ category }}-measure" name="{{ category }}-measure" value="{{ submission.data[category + '-measure'] }}" disabled>
            </div>

            <div class="form-group">
                <label for="{{ category }}-completion">Percentage of Completion</label>
                <select id="{{ category }}-completion" name="{{ category }}-completion" disabled>
                    <option value=">=110%" {% if submission.data[category + '-completion'] == '>=110%' %}selected{% endif %}>>=110%</option>
                    <option value="90-109%" {% if submission.data[category + '-completion'] == '90-109%' %}selected{% endif %}>90-109%</option>
                    <option value="70-89%" {% if submission.data[category + '-completion'] == '70-89%' %}selected{% endif %}>70-89%</option>
                    <option value="50-69%" {% if submission.data[category + '-completion'] == '50-69%' %}selected{% endif %}>50-69%</option>
                    <option value="below 50%" {% if submission.data[category + '-completion'] == 'below 50%' %}selected{% endif %}>below 50%</option>
                </select>
            </div>

            <div class="form-group">
                <label for="{{ category }}-comments">Comments on Achievement</label>
                <textarea id="{{ category }}-comments" name="{{ category }}-comments" disabled>{{ submission.data[category + '-comments'] }}</textarea>
            </div>

            <div class="form-group">
                <label for="{{ category }}-self-rating">Self-Assessment Rating</label>
                <select id="{{ category }}-self-rating" name="{{ category }}-self-rating" disabled>
                    <option value="Excellent" {% if submission.data[category + '-self-rating'] == 'Excellent' %}selected{% endif %}>Excellent</option>
                    <option value="Very Good" {% if submission.data[category + '-self-rating'] == 'Very Good' %}selected{% endif %}>Very Good</option>
                    <option value="Good" {% if submission.data[category + '-self-rating'] == 'Good' %}selected{% endif %}>Good</option>
                    <option value="Needs Improvement" {% if submission.data[category + '-self-rating'] == 'Needs Improvement' %}selected{% endif %}>Needs Improvement</option>
                    <option value="Below Expectations" {% if submission.data[category + '-self-rating'] == 'Below Expectations' %}selected{% endif %}>Below Expectations</option>
                </select>
            </div>

            <div class="form-group">
                <label for="{{ category }}-manager-rating">
                    {% if submission.employee_role == 'manager' %}
                    HR Rating
                    {% else %}
                    Reporting Manager Rating
                    {% endif %}
                </label>
                <select id="{{ category }}-manager-rating" 
                        class="hr-rating" 
                        data-category="{{ category }}"
                        data-submission-id="{{ submission._id }}"
                        {% if submission.employee_role != 'manager' %}disabled{% endif %}>
                    <option value="">Select Rating</option>
                    <option value="Excellent" {% if submission.data[category + '-manager-rating'] == 'Excellent' %}selected{% endif %}>Excellent</option>
                    <option value="Very Good" {% if submission.data[category + '-manager-rating'] == 'Very Good' %}selected{% endif %}>Very Good</option>
                    <option value="Good" {% if submission.data[category + '-manager-rating'] == 'Good' %}selected{% endif %}>Good</option>
                    <option value="Needs Improvement" {% if submission.data[category + '-manager-rating'] == 'Needs Improvement' %}selected{% endif %}>Needs Improvement</option>
                    <option value="Below Expectations" {% if submission.data[category + '-manager-rating'] == 'Below Expectations' %}selected{% endif %}>Below Expectations</option>
                </select>
            </div>

            <div class="form-group">
                <label for="{{ category }}-manager-comments">
                    {% if submission.employee_role == 'manager' %}
                    HR Comments
                    {% else %}
                    Comments by Reporting Manager
                    {% endif %}
                </label>
                <div class="input-container">
                    <textarea id="{{ category }}-manager-comments"
                             class="hr-comments"
                             data-category="{{ category }}"
                             data-submission-id="{{ submission._id }}"
                             {% if submission.employee_role != 'manager' %}disabled{% endif %}>{{ submission.data[category + '-manager-comments'] }}</textarea>
                    {% if submission.employee_role == 'manager' %}
                    <button type="button" class="mic-icon" data-target="{{ category }}-manager-comments"></button>
                    {% endif %}
                </div>
            </div>
            {% if submission.employee_role == 'manager' %}
            <button class="save-feedback-btn" data-submission-id="{{ submission._id }}">Save HR Feedback</button>
            {% endif %}
            {% endif %}
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('toggle-form').addEventListener('click', async () => {
    try {
        const response = await fetch('/api/toggle-form', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const button = document.getElementById('toggle-form');
            button.textContent = data.enabled ? 'Disable Form' : 'Enable Form';
        } else {
            alert('Failed to toggle form status');
        }
    } catch (error) {
        alert('An error occurred. Please try again.');
    }
});

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.save-feedback-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const submissionId = this.dataset.submissionId;
            const submissionCard = document.querySelector(`.submission-card[data-submission-id="${submissionId}"]`);
            const updates = {};

            submissionCard.querySelectorAll('.hr-rating, .hr-comments').forEach(element => {
                const category = element.dataset.category;
                const field = element.classList.contains('hr-rating') ? 'manager-rating' : 'manager-comments';
                const key = `${category}-${field}`;
                updates[key] = element.value;
            });

            try {
                const response = await fetch(`/api/submit-hr-feedback/${submissionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });

                if (!response.ok) {
                    throw new Error('Failed to save feedback');
                }

                alert('Feedback saved successfully');
            } catch (error) {
                alert(error.message);
            }
        });
    });

    document.querySelectorAll('.mic-icon').forEach(icon => {
        icon.addEventListener('click', function() {
            const targetId = this.dataset.target;
            startDictation(targetId, this);
        });
    });

    function startDictation(fieldId, micIcon) {
        if (window.hasOwnProperty('webkitSpeechRecognition')) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            micIcon.classList.add('mic-active');
            recognition.start();

            recognition.onresult = function(e) {
                const field = document.getElementById(fieldId);
                field.value = '';
                for (let i = 0; i < e.results.length; i++) {
                    field.value += e.results[i][0].transcript;
                }
                if (e.results[0].isFinal) {
                    micIcon.classList.remove('mic-active');
                    recognition.stop();
                }
            };

            recognition.onerror = function(e) {
                micIcon.classList.remove('mic-active');
                recognition.stop();
            };

            recognition.onend = function() {
                micIcon.classList.remove('mic-active');
            };
        }
    }
});
</script>
{% endblock %}
