{% extends "base.html" %}

{% block content %}
<div class="forms-container">
    <h2>Team Submissions</h2>

    {% if team_name %}
    <div class="team-info">
        <p>You are the manager of <strong>{{ team_name }}</strong> team.</p>
    </div>
    {% else %}
    <div class="team-info">
        <p>You are not assigned to any team.</p>
    </div>
    {% endif %}

    <div class="submissions-list">
        {% for submission in submissions %}
        <div class="submission-card" data-submission-id="{{ submission._id }}">
            <div class="submission-header">
                Submitted by: {{ submission.employee_name }}
                <span class="submission-date">
                    {{ submission.created_at.strftime('%B %d, %Y, %I:%M:%S %p') }}
                </span>
            </div>
            {% for category, messages in submission.data.items() %}
            {% if not category.endswith('-measure') and not category.endswith('-completion') and not category.endswith('-comments') and not category.endswith('-self-rating') and not category.endswith('-manager-rating') and not category.endswith('-manager-comments') %}
            <div class="submission-item">
                <strong>{{ category }}:</strong>
                <ul>
                    {% for message in messages %}
                    <li>{{ message }}</li>
                    {% endfor %}
                </ul>

                <div class="form-group">
                    <label>Measure of Success</label>
                    <input type="text" value="{{ submission.data[category + '-measure'] }}" disabled>
                </div>

                <div class="form-group">
                    <label>Percentage of Completion</label>
                    <input type="text" value="{{ submission.data[category + '-completion'] }}" disabled>
                </div>

                <div class="form-group">
                    <label>Comments on Achievement</label>
                    <textarea disabled>{{ submission.data[category + '-comments'] }}</textarea>
                </div>

                <div class="form-group">
                    <label>Self-Assessment Rating</label>
                    <input type="text" value="{{ submission.data[category + '-self-rating'] }}" disabled>
                </div>

                <div class="form-group">
                    <label for="{{ submission._id }}-{{ category }}-manager-rating">Reporting Manager Rating</label>
                    <select id="{{ submission._id }}-{{ category }}-manager-rating" 
                            class="manager-rating" 
                            data-category="{{ category }}"
                            data-submission-id="{{ submission._id }}">
                        <option value="">Select Rating</option>
                        <option value="Excellent" {% if submission.data[category + '-manager-rating'] == 'Excellent' %}selected{% endif %}>Excellent</option>
                        <option value="Very Good" {% if submission.data[category + '-manager-rating'] == 'Very Good' %}selected{% endif %}>Very Good</option>
                        <option value="Good" {% if submission.data[category + '-manager-rating'] == 'Good' %}selected{% endif %}>Good</option>
                        <option value="Needs Improvement" {% if submission.data[category + '-manager-rating'] == 'Needs Improvement' %}selected{% endif %}>Needs Improvement</option>
                        <option value="Below Expectations" {% if submission.data[category + '-manager-rating'] == 'Below Expectations' %}selected{% endif %}>Below Expectations</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="{{ submission._id }}-{{ category }}-manager-comments">Reporting Manager Comments</label>
                    <textarea id="{{ submission._id }}-{{ category }}-manager-comments"
                            class="manager-comments"
                            data-category="{{ category }}"
                            data-submission-id="{{ submission._id }}">{{ submission.data[category + '-manager-comments'] }}</textarea>
                </div>
            </div>
            {% endif %}
            {% endfor %}
            <button class="save-feedback-btn" data-submission-id="{{ submission._id }}">Save Feedback</button>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.save-feedback-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const submissionId = this.dataset.submissionId;
            const submissionCard = document.querySelector(`.submission-card[data-submission-id="${submissionId}"]`);
            const updates = {};

            submissionCard.querySelectorAll('.manager-rating, .manager-comments').forEach(element => {
                const category = element.dataset.category;
                const field = element.classList.contains('manager-rating') ? 'manager-rating' : 'manager-comments';
                const key = `${category}-${field}`;
                updates[key] = element.value;
            });

            try {
                const response = await fetch(`/api/update-feedback/${submissionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });

                if (!response.ok) {
                    throw new Error('Failed to save feedback');
                }

                alert('Feedback saved successfully');
            } catch (error) {
                alert(error.message);
            }
        });
    });
});
</script>
{% endblock %}
